# conf.d/api-gateway.conf
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    # Health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status": "healthy", "service": "nginx-api-gateway", "timestamp": "$time_iso8601"}';
    }

    # Metrics endpoint (для мониторинга)
    location = /metrics {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 192.168.122.0/24;  # KVM подсеть
        deny all;
    }

    # Root - информация о gateway
    location = / {
        proxy_pass http://192.168.122.252:8080;
    }

    # ====================
    # МОДЕЛЬНЫЕ ЭНДПОИНТЫ
    # ====================

    # Проксирование /model/chat на Ollama
    location ~ ^/model/chat(/|$) {
        # Полное проксирование URL
        proxy_pass http://192.168.122.252:8094;

        # Передаем все заголовки
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Для SSE/WebSocket если нужно
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;

        # Таймауты для длинных запросов
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_connect_timeout 75s;

        # Дополнительные заголовки для CORS если нужно
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';

        # Обработка OPTIONS запросов для CORS
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }


    # Логирование ошибок
    error_page 400 401 402 403 404 405 408 409 410 411 412 413 414 415 416 417 500 501 502 503 504 505 /error.json;

    location = /error.json {
        internal;
        add_header Content-Type application/json;
        return 200 '{"error": "$status", "path": "$uri", "timestamp": "$time_iso8601"}';
    }
}
