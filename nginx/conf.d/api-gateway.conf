# conf.d/api-gateway.conf
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    # Health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status": "healthy", "service": "nginx-api-gateway", "timestamp": "$time_iso8601"}';
    }

    # Metrics endpoint (для мониторинга)
    location = /metrics {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 192.168.122.0/24;  # KVM подсеть
        deny all;
    }

    # Root - информация о gateway
    location = / {
        add_header Content-Type application/json;
        return 200 '{"service": "api-gateway", "version": "1.0", "endpoints": ["/model/chat", "/model/generate", "/model/tags"]}';
    }

    # ====================
    # МОДЕЛЬНЫЕ ЭНДПОИНТЫ
    # ====================

    # Проксирование /model/chat на Ollama
    location ~ ^/model/chat(/|$) {
        # Полное проксирование URL
        rewrite ^/model/chat(/?)(.*)$ /api/chat$2 break;

        # Прокси на model gate service
        proxy_pass http://192.168.122.252:8094;

        # Передаем все заголовки
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Для SSE/WebSocket если нужно
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;

        # Таймауты для длинных запросов
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_connect_timeout 75s;

        # Дополнительные заголовки для CORS если нужно
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';

        # Обработка OPTIONS запросов для CORS
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }


    # Логирование ошибок
    error_page 400 401 402 403 404 405 408 409 410 411 412 413 414 415 416 417 500 501 502 503 504 505 /error.json;

    location = /error.json {
        internal;
        add_header Content-Type application/json;
        return 200 '{"error": "$status", "message": "$status_text", "path": "$uri", "timestamp": "$time_iso8601"}';
    }
}

# HTTPS сервер (если будут сертификаты)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name _;

    # Заглушка для SSL - нужно добавить реальные сертификаты
    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;

    # SSL настройки
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Проброс на HTTP сервер
    location / {
        proxy_pass http://127.0.0.1:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
    }
}